pipeline{
    agent any 
    stages{
        stage('Stage 1: Cloning Repo') {
            steps{
                git credentialsId: 'github', url: 'https://github.com/Task0209/chillapp.git'
            }
        }
        stage('Stage 2: Build the Docker Image') {
            steps{
                sh 'whoami'
                sh "docker build -t task0209/chillapp:${BUILD_NuMBER} . "
            }
        }
        
        stage('Stage 3: Validate the docker image') {
           steps {
                sh 'docker images '
              }
        }
        
        stage('Stage 4: Login Docker') {
           steps {
                  withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'PassWord', usernameVariable: 'UserName')]) {
                              sh "docker login -u ${env.UserName} -p ${env.PassWord}"
                }
               }
         
           }
           stage('Stage 5: Push Docker image') {
             steps {
                     sh "docker push docker.io/task0209/chillapp:${BUILD_NuMBER}"
                   }
         }
           stage ('Stage 6: Install & Download Kubectl'){
             steps {
                   sh 'curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"'  
                    sh 'chmod u+x ./kubectl'
                    sh 'chmod u+x ./deploy.yaml'
                    sh 'chmod u+x ./service.yaml'
                    sh 'ls -l'
                    sh 'pwd'
                  }
            
             }
             
             stage ('Stage 7: Deploying to K8s Cluster'){
             steps {
                 script {
                      withKubeConfig(credentialsId: 'kkk', serverUrl: 'https://192.168.0.50:6443') {
                                  sh './kubectl create -f deploy.yaml'
                                  sh './kubectl create -f service.yaml'
                                 }
                  }
             }
           }
           }
      }  
    
